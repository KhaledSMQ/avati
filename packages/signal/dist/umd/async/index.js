/*!
 * @avatijs/signal 0.1.1
 * Copyright (c) 2024 Khaled Sameer <khaled.smq@hotmail.com>
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://avati.io/ for details.
 */
!function(t,s){"object"==typeof exports&&"object"==typeof module?module.exports=s():"function"==typeof define&&define.amd?define("Avati",[],s):"object"==typeof exports?exports.Avati=s():(t.Avati=t.Avati||{},t.Avati["async/index"]=s())}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var t={d:(s,e)=>{for(var i in e)t.o(e,i)&&!t.o(s,i)&&Object.defineProperty(s,i,{enumerable:!0,get:e[i]})},o:(t,s)=>Object.prototype.hasOwnProperty.call(t,s),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"t",{value:!0})}},s={};t.r(s),t.d(s,{AsyncSignal:()=>c,asyncSignal:()=>a});class e extends Error{constructor(t){super(`Cannot ${t} a disposed signal`),this.name="SignalDisposedError"}}class i{constructor(){this.computationStack=[],this.batchDepth=0,this.batchQueue=new Set,this.activeEffects=new Set}static getInstance(){return this.instance||(this.instance=new i),this.instance}getCurrentComputation(){return this.computationStack[this.computationStack.length-1]}pushComputation(t){t&&this.computationStack.includes(t)||this.computationStack.push(t)}popComputation(){this.computationStack.pop()}isBatching(){return this.batchDepth>0}beginBatch(){this.batchDepth++}endBatch(){this.batchDepth--,0===this.batchDepth&&this.flushBatchQueue()}addToBatchQueue(t){this.batchQueue.add(t)}flushBatchQueue(){const t=new Set(this.batchQueue);this.batchQueue.clear();const s=new Set;for(const e of t)for(const t of e.getDependents())s.add(t);for(const t of s)t.markDirty()}setCurrentComputation(t){this.computationStack[this.computationStack.length-1]=t}registerEffect(t){this.activeEffects.add(t)}unregisterEffect(t){this.activeEffects.delete(t)}isInEffect(){return this.activeEffects.size>0}}class n{constructor(t,s={}){var e;this.dependents=new Set,this.disposed=!1,this.i=t,this.equals=null!==(e=s.equals)&&void 0!==e?e:Object.is,this.name=s.name||"anonymous"}isCommutable(){throw Error("Method not implemented.")}get value(){if(this.disposed)throw new e("read from");return this.trackDependency(),this.i}set value(t){if(this.disposed)throw new e("write to");this.equals(this.i,t)||(this.i=t,this.notifyDependents())}get_value_bypass_tracking(){if(this.disposed)throw new e("read from");return this.i}update(t){this.value=t(this.i)}addDependent(t){this.dependents.add(t)}removeDependent(t){this.dependents.delete(t)}notifyDependents(){const t=i.getInstance();if(t.isBatching())t.addToBatchQueue(this);else for(const t of this.dependents)t.markDirty()}dispose(){var t;if(this.disposed)return;this.disposed=!0;const s=new Set(this.dependents);this.dependents.clear();for(const e of s)"ComputedSignal"==e.constructor.name||"ComputedSignal"==(null===(t=e.signal)||void 0===t?void 0:t.constructor.name)?("ComputedSignal"==e.constructor.name?e:e.signal).dispose():e.dispose()}isDisposed(){return this.disposed}getDependents(){return this.dependents||new Set}hasDependents(){return this.dependents.size>0}toString(){return`Signal(${this.name})`}trackDependency(){const t=i.getInstance().getCurrentComputation();t&&(t.addDependency(this),this.addDependent(t))}}class r{constructor(){this.queue=new Set,this.processing=!1,this.updateDepth=0,this.maxUpdateDepth=1e3}static getInstance(){return this.instance||(this.instance=new r),this.instance}schedule(t){if(this.updateDepth>=this.maxUpdateDepth)throw Error("Maximum update depth exceeded - possible circular dependency");this.queue.add(t),this.processing||this.processQueue()}processQueue(){this.processing=!0,this.updateDepth++;try{for(;this.queue.size>0;){const t=Array.from(this.queue);this.queue.clear(),t.sort(((t,s)=>t.getDepth()-s.getDepth()));for(const s of t)s.isDirty()&&!s.isDisposed()&&s.recompute()}}finally{this.processing=!1,this.updateDepth--}}}class h{constructor(t){this.dirty=!0,this.disposed=!1,this.dependencies=new Set,this.dependents=new Set,this.depth=0,this.name=t}addDependency(t){this.dependencies.has(t)||(this.dependencies.add(t),"ComputedSignal"==t.constructor.name&&this.updateDepth())}removeDependency(t){this.dependencies.delete(t)&&this.updateDepth()}dispose(){this.disposed||(this.disposed=!0,this.clearDependencies(),this.dependents.clear())}isDirty(){return this.dirty}isDisposed(){return this.disposed}getDepth(){return this.depth}markDirty(){this.disposed||(this.dirty=!0,r.getInstance().schedule(this))}hasSignal(t){return this.dependencies.has(t)}clearDependencies(){for(const t of this.dependencies)t.removeDependent(this);this.dependencies.clear(),this.updateDepth()}updateDepth(){const t=this.depth;let s=0;for(const t of this.dependencies)"ComputedSignal"==t.constructor.name&&(s=Math.max(s,t.getDepth()+1));if(t!==s){this.depth=s;for(const t of this.dependents)t.updateDepth()}}}class o extends h{constructor(t){super("subscription"),this.callback=t}recompute(){if(this.disposed)return;const t=i.getInstance(),s=t.getCurrentComputation();t.setCurrentComputation(this);try{this.callback()}finally{s&&t.setCurrentComputation(s),this.dirty=!1}}}class u extends n{constructor(t,s={}){super(t,s)}subscribe(t){if(this.disposed)throw new e("subscribe to");const s=new o((()=>t(this.value)));return s.recompute(),()=>s.dispose()}}class c extends u{constructor(t,s={}){super({data:null,loading:!1,error:null,timestamp:0},s),this.abortController=null,this.fetchFn=t,this.options=s}async fetch(t=!1){var s,e,i,n,r,h,o;if(this.isCacheValid()&&!t)return this.value.data;this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.value={...this.value,loading:!0,error:null};let u=0;const c=(null===(s=this.options.retryConfig)||void 0===s?void 0:s.attempts)||1,a=(null===(e=this.options.retryConfig)||void 0===e?void 0:e.delay)||1e3,l=(null===(i=this.options.retryConfig)||void 0===i?void 0:i.backoffFactor)||2;for(;c>u;)try{const t=await this.fetchFn();return this.value={data:t,loading:!1,error:null,timestamp:Date.now()},null===(r=(n=this.options).onSuccess)||void 0===r||r.call(n,t),t}catch(t){if(u++,u===c)return this.value={...this.value,loading:!1,error:t},null===(o=(h=this.options).onError)||void 0===o||o.call(h,t),null;await new Promise((t=>setTimeout(t,a*Math.pow(l,u-1))))}return null}refresh(){return this.fetch(!0)}dispose(){this.abortController&&this.abortController.abort(),super.dispose()}isCacheValid(){var t;if(!(null===(t=this.options.cache)||void 0===t?void 0:t.enabled))return!1;if(!this.value.data)return!1;const s=this.options.cache.ttl||3e5;return Date.now()-this.value.timestamp<s}}function a(t,s){return new c(t,s)}return s})()));
//# sourceMappingURL=index.js.map