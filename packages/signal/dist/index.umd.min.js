/*!
 * @avatijs/signal 0.1.1
 * Copyright (c) 2024 Khaled Sameer <khaled.smq@hotmail.com>
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://avati.io/ for details.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Avati",[],t):"object"==typeof exports?exports.Avati=t():e.Avati=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AsyncSignal:()=>P,CircularDependencyError:()=>a,Computation:()=>o,ComputedSignal:()=>d,EffectImpl:()=>v,LocalStorageProvider:()=>O,MemoryStorageProvider:()=>j,QueueSignal:()=>A,SessionStorageProvider:()=>Q,Signal:()=>u,SignalContext:()=>s,SignalDisposedError:()=>r,SignalMonitor:()=>l,UpdateQueue:()=>n,asyncSignal:()=>U,batch:()=>i,combine:()=>h,computed:()=>c,createQueueSignal:()=>z,createSignal:()=>p,debounced:()=>w,debug:()=>D,defaultEquals:()=>C,effect:()=>g,filtered:()=>y,getSignalDepth:()=>E,hasCircularDependency:()=>k,isSignal:()=>q,map:()=>m,peek:()=>S,persisted:()=>B,resetSignalSystem:()=>x,serializeSignal:()=>I,threshold:()=>b,throttled:()=>_,validated:()=>f,withHistory:()=>T});class s{constructor(){this.computationStack=[],this.batchDepth=0,this.batchQueue=new Set,this.activeEffects=new Set}static getInstance(){return this.instance||(this.instance=new s),this.instance}getCurrentComputation(){return this.computationStack[this.computationStack.length-1]}pushComputation(e){e&&this.computationStack.includes(e)||this.computationStack.push(e)}popComputation(){this.computationStack.pop()}isBatching(){return this.batchDepth>0}beginBatch(){this.batchDepth++}endBatch(){this.batchDepth--,0===this.batchDepth&&this.flushBatchQueue()}addToBatchQueue(e){this.batchQueue.add(e)}flushBatchQueue(){const e=new Set(this.batchQueue);this.batchQueue.clear();const t=new Set;for(const s of e)for(const e of s.getDependents())t.add(e);for(const e of t)e.markDirty()}setCurrentComputation(e){this.computationStack[this.computationStack.length-1]=e}registerEffect(e){this.activeEffects.add(e)}unregisterEffect(e){this.activeEffects.delete(e)}isInEffect(){return this.activeEffects.size>0}}function i(e){const t=s.getInstance();t.beginBatch();try{return e()}finally{t.endBatch()}}class n{constructor(){this.queue=new Set,this.processing=!1,this.updateDepth=0,this.maxUpdateDepth=1e3}static getInstance(){return this.instance||(this.instance=new n),this.instance}schedule(e){if(this.updateDepth>=this.maxUpdateDepth)throw Error("Maximum update depth exceeded - possible circular dependency");this.queue.add(e),this.processing||this.processQueue()}processQueue(){this.processing=!0,this.updateDepth++;try{for(;this.queue.size>0;){const e=Array.from(this.queue);this.queue.clear(),e.sort(((e,t)=>e.getDepth()-t.getDepth()));for(const t of e)t.isDirty()&&!t.isDisposed()&&t.recompute()}}finally{this.processing=!1,this.updateDepth--}}}class o{constructor(e){this.dirty=!0,this.disposed=!1,this.dependencies=new Set,this.dependents=new Set,this.depth=0,this.name=e}addDependency(e){this.dependencies.has(e)||(this.dependencies.add(e),e instanceof d&&this.updateDepth())}removeDependency(e){this.dependencies.delete(e)&&this.updateDepth()}dispose(){this.disposed||(this.disposed=!0,this.clearDependencies(),this.dependents.clear())}isDirty(){return this.dirty}isDisposed(){return this.disposed}getDepth(){return this.depth}markDirty(){this.disposed||(this.dirty=!0,n.getInstance().schedule(this))}hasSignal(e){return this.dependencies.has(e)}clearDependencies(){for(const e of this.dependencies)e.removeDependent(this);this.dependencies.clear(),this.updateDepth()}updateDepth(){const e=this.depth;let t=0;for(const e of this.dependencies)e instanceof d&&(t=Math.max(t,e.getDepth()+1));if(e!==t){this.depth=t;for(const e of this.dependents)e.updateDepth()}}}class r extends Error{constructor(e){super(`Cannot ${e} a disposed signal`),this.name="SignalDisposedError"}}class a extends Error{constructor(e){super("Circular dependency detected"+(e?` in signal "${e}"`:"")),this.name="CircularDependencyError"}}class u{constructor(e,t={}){var s;this.dependents=new Set,this.disposed=!1,this._value=e,this.equals=null!==(s=t.equals)&&void 0!==s?s:Object.is,this.name=t.name||"anonymous"}get value(){if(this.disposed)throw new r("read from");return this.trackDependency(),this._value}set value(e){if(this.disposed)throw new r("write to");this.equals(this._value,e)||(this._value=e,this.notifyDependents())}get_value_bypass_tracking(){if(this.disposed)throw new r("read from");return this._value}update(e){this.value=e(this._value)}subscribe(e){if(this.disposed)throw new r("subscribe to");const t=new d((()=>e(this.value)));return()=>t.dispose()}addDependent(e){this.dependents.add(e)}removeDependent(e){this.dependents.delete(e)}notifyDependents(){const e=s.getInstance();if(e.isBatching())e.addToBatchQueue(this);else for(const e of this.dependents)e.markDirty()}dispose(){if(this.disposed)return;this.disposed=!0;const e=new Set(this.dependents);this.dependents.clear();for(const t of e)if(t instanceof d||t.signal instanceof d){(t instanceof d?t:t.signal).dispose()}else t.dispose()}isDisposed(){return this.disposed}getDependents(){return this.dependents||new Set}hasDependents(){return this.dependents.size>0}toString(){return`Signal(${this.name})`}trackDependency(){const e=s.getInstance().getCurrentComputation();e&&(e.addDependency(this),this.addDependent(e))}}class d extends u{constructor(e,t={}){super(void 0,t),this.computeFn=e,this.computation=new class extends o{constructor(e){super(e.name),this.signal=e}recompute(){if(this.disposed)return;const e=s.getInstance(),t=e.getCurrentComputation();if(e.setCurrentComputation(this),e.isInEffect())throw new a("Cannot create computed signal that depends on effects");try{for(const e of this.dependencies)if(e.isDisposed())throw this.signal.dispose(),new r("read from disposed dependency");const e=this.signal.computeFn();this.signal.equals(this.signal._value,e)||(this.signal._value=e,this.signal.notifyDependents())}catch(e){throw e instanceof r&&this.signal.dispose(),e}finally{t&&e.setCurrentComputation(t),this.dirty=!1}}}(this),this.computation.recompute()}get value(){if(this.disposed)throw new r("read from");const e=this.computation.dependencies;for(const t of e)if(t.isDisposed())throw this.dispose(),new r("read from disposed dependency");return this.computation.isDirty()&&this.computation.recompute(),this.trackDependency(),this._value}set value(e){throw Error("Cannot set the value of a computed signal")}getDepth(){return this.computation.getDepth()}dispose(){if(!this.disposed){super.dispose(),this.computation.dispose();for(const e of this.dependents)if(e instanceof d||e.signal instanceof d){(e instanceof d?e:e.signal).dispose()}}}}function c(e,t){return new d(e,t)}function h(e,t){var s;return c((()=>e.map((e=>e.value))),{equals:null!==(s=null==t?void 0:t.equals)&&void 0!==s?s:(e,t)=>!(!e||!t||e.length!==t.length)&&e.every(((e,s)=>Object.is(e,t[s]))),name:(null==t?void 0:t.name)||`Signal(combine)[${e.map((e=>""+e)).join(", ")}]`})}class l{static trackUpdate(e){this.metrics.updates++,this.updateTimes.push(e),this.updateTimes.length>100&&this.updateTimes.shift(),this.metrics.averageUpdateTime=this.updateTimes.reduce(((e,t)=>e+t),0)/this.updateTimes.length}static trackComputation(e){this.metrics.computations++,this.metrics.maxChainDepth=Math.max(this.metrics.maxChainDepth,e)}static getMetrics(){return{...this.metrics}}static reset(){this.metrics={updates:0,computations:0,maxChainDepth:0,averageUpdateTime:0},this.updateTimes=[]}}function p(e,t){return new u(e,t)}function f(e,t,s){const i=p(e,s),n=c((()=>{const e=t(i.value);return"string"==typeof e?e:e?null:"Validation failed"}));return new Proxy(i,{get(e,t){if("value"===t){const t=n.value;if(t)throw Error(t);return e.value}return e[t]},set(e,s,i){if("value"===s){const s=t(i);if("string"==typeof s)throw Error(s);if(!s)throw Error("Validation failed");e.value=i}return!0}})}function m(e,t,s){return c((()=>t(e.value)),s)}l.metrics={updates:0,computations:0,maxChainDepth:0,averageUpdateTime:0},l.updateTimes=[];class v{constructor(e,t){this.disposed=!1,this.computation=new class extends o{constructor(e,s){super(t),this.effect=e,this.fn=s}recompute(){if(this.disposed)return;const e=s.getInstance();e.pushComputation(this);try{e.pushComputation(this),e.registerEffect(this.effect),this.effect.runEffect()}finally{e.unregisterEffect(this.effect),e.popComputation(),this.dirty=!1}}}(this,e),this.computation.recompute()}dispose(){if(!this.disposed){if(this.disposed=!0,this.cleanup)try{this.cleanup()}catch(e){console.error("Error in effect cleanup:",e)}this.computation.dispose()}}runEffect(){if(!this.disposed){if(this.cleanup)try{this.cleanup()}catch(e){console.error("Error in effect cleanup:",e)}try{this.cleanup=this.computation.fn()}catch(e){throw console.error("Error in effect:",e),e}}}}function g(e,t){return new v(e,t)}function w(e,t,s){const i=p(e.value,s);let n;return g((()=>{const s=e.value;return n&&clearTimeout(n),n=setTimeout((()=>{i.value=s}),t),()=>{n&&clearTimeout(n)}})),i}function y(e,t,s){const i=p(e.value,s);return g((()=>{const s=e.value;t(s)&&(i.value=s)})),i}function D(e,t){return g((()=>{console.log(`[Signal Debug] ${t}:`,e.value)}),"debug-"+t),e}function S(e){const t=s.getInstance(),i=t.getCurrentComputation();t.setCurrentComputation(void 0);try{return e.get_value_bypass_tracking()}finally{i&&t.setCurrentComputation(i)}}function b(e,t,s){return c((()=>{const s=e.value,i=S(e);return t>Math.abs(s-i)?i:s}),{...s,equals:(e,s)=>t>Math.abs(e-s)})}const C=(e,t)=>Object.is(e,t),I=e=>JSON.stringify({value:e.value,name:e.name,disposed:e.disposed});function q(e){return e instanceof u}function E(e){return e instanceof d?e.getDepth():0}function k(e){const t=new Set,s=new Set;return function e(i){var n;if(s.has(i))return!0;if(t.has(i))return!1;t.add(i),s.add(i);const o=i.dependents||new Set;for(const t of o)if((null===(n=t.computation)||void 0===n?void 0:n.signal)&&e(t.computation.signal))return!0;return s.delete(i),!1}(e)}function x(){s.instance=void 0,n.instance=void 0,l.reset()}function T(e,t=10,s){var n;const o=null!==(n=null==s?void 0:s.equals)&&void 0!==n?n:C,r=p(e,{...s,equals:o}),a=p([e]),u=p(0),d=c((()=>u.value>0)),h=c((()=>a.value.length-1>u.value)),l=Object.create(r);return l.history=a,l.canUndo=d,l.canRedo=h,Object.defineProperty(l,"value",{get:()=>r.value,set:e=>{o(r.value,e)||i((()=>{const s=u.value+1,i=a.value.slice(0,s).concat([e]);i.length>t?(i.shift(),u.value=s-1):u.value=s,a.value=i,r.value=e}))}}),l.undo=()=>{d.value&&i((()=>{u.value--,r.value=a.value[u.value]}))},l.redo=()=>{h.value&&i((()=>{u.value++,r.value=a.value[u.value]}))},l}function _(e,t,s){const i=p(e.value,s);let n,o=0;return g((()=>{const s=e.value,r=Date.now();return t>r-o?n||(n=setTimeout((()=>{i.value=s,o=Date.now(),n=void 0}),t-(r-o))):(i.value=s,o=r),()=>{n&&clearTimeout(n)}})),i}class O{getItem(e){if("undefined"==typeof window)return null;const t=window.localStorage.getItem(e);return t?JSON.parse(t):null}setItem(e,t){"undefined"!=typeof window&&window.localStorage.setItem(e,JSON.stringify(t))}removeItem(e){"undefined"!=typeof window&&window.localStorage.removeItem(e)}}class Q{getItem(e){if("undefined"==typeof window)return null;const t=window.sessionStorage.getItem(e);return t?JSON.parse(t):null}setItem(e,t){"undefined"!=typeof window&&window.sessionStorage.setItem(e,JSON.stringify(t))}removeItem(e){"undefined"!=typeof window&&window.sessionStorage.removeItem(e)}}class j{constructor(){this.store=new Map}getItem(e){var t;return null!==(t=this.store.get(e))&&void 0!==t?t:null}setItem(e,t){this.store.set(e,t)}removeItem(e){this.store.delete(e)}}class M extends u{constructor(e,t,s,i){const n=s.getItem(e);super(null!=n?n:t,i),this.disposed=!1,this.key=e,this.storage=s,g((()=>{this.disposed||this.storage.setItem(this.key,this.value)}),"persist-"+e)}get value(){if(this.disposed)throw new r("Cannot read from disposed signal");return super.value}set value(e){if(this.disposed)throw new r("Cannot write to disposed signal");super.value=e}update(e){if(this.disposed)throw new r("Cannot update disposed signal");this.value=e(this.value)}dispose(){this.disposed||(this.disposed=!0,this.storage.removeItem(this.key),super.dispose())}reload(){if(this.disposed)throw new r("Cannot reload disposed signal");const e=this.storage.getItem(this.key);null!==e&&(this.value=e)}clear(){if(this.disposed)throw new r("Cannot clear disposed signal");this.storage.removeItem(this.key)}isDisposed(){return this.disposed}}function B(e,t,s,i){return new M(e,t,s,i)}class P extends u{constructor(e,t={}){super({data:null,loading:!1,error:null,timestamp:0},t),this.abortController=null,this.fetchFn=e,this.options=t}async fetch(e=!1){var t,s,i,n,o,r,a;if(this.isCacheValid()&&!e)return this.value.data;this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.value={...this.value,loading:!0,error:null};let u=0;const d=(null===(t=this.options.retryConfig)||void 0===t?void 0:t.attempts)||1,c=(null===(s=this.options.retryConfig)||void 0===s?void 0:s.delay)||1e3,h=(null===(i=this.options.retryConfig)||void 0===i?void 0:i.backoffFactor)||2;for(;d>u;)try{const e=await this.fetchFn();return this.value={data:e,loading:!1,error:null,timestamp:Date.now()},null===(o=(n=this.options).onSuccess)||void 0===o||o.call(n,e),e}catch(e){if(u++,u===d)return this.value={...this.value,loading:!1,error:e},null===(a=(r=this.options).onError)||void 0===a||a.call(r,e),null;await new Promise((e=>setTimeout(e,c*Math.pow(h,u-1))))}return null}refresh(){return this.fetch(!0)}dispose(){this.abortController&&this.abortController.abort(),super.dispose()}isCacheValid(){var e;if(!(null===(e=this.options.cache)||void 0===e?void 0:e.enabled))return!1;if(!this.value.data)return!1;const t=this.options.cache.ttl||3e5;return Date.now()-this.value.timestamp<t}}function U(e,t){return new P(e,t)}class A{constructor(){this.queue=p([])}enqueue(e,t=0){const s=Math.random().toString(36).substring(2),i={id:s,data:e,priority:t,timestamp:Date.now()};return this.queue.value=[...this.queue.value,i].sort(((e,t)=>t.priority-e.priority||e.timestamp-t.timestamp)),s}dequeue(){if(this.isEmpty())return;const[e,...t]=this.queue.value;return this.queue.value=t,null==e?void 0:e.data}peek(){var e;return null===(e=this.queue.value[0])||void 0===e?void 0:e.data}remove(e){const t=this.queue.value.length;return this.queue.value=this.queue.value.filter((t=>t.id!==e)),t!==this.queue.value.length}clear(){this.queue.value=[]}isEmpty(){return 0===this.queue.value.length}size(){return this.queue.value.length}getQueue(){return this.queue}}function z(){return new A}return t})()));
//# sourceMappingURL=index.umd.min.js.map