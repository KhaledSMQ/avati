<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Debounce Utility Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #6b7280;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --text: #1f2937;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--background);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .demo-section {
            background: white;
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .demo-section h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .demo-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        input, button {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background: var(--primary-dark);
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
        }

        .metric-card h4 {
            color: var(--secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .code-block {
            margin: 1rem 0;
            background: #1f2937;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
        }

        .results {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
        }

        .result-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .chart {
            width: 100%;
            height: 200px;
            margin-top: 1rem;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .warning {
            background: #fff5f5;
            color: #e53e3e;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        .warning a {
            color: #cc2c2c;
            font-weight: 700;
            text-decoration: underline;
        }
        .warning span {
            width: 1.5rem;
            height: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;

        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>Advanced Debounce Utility Demo</h1>
        <p>Real-world examples and use cases for the TypeScript debounce utility</p>
    </header>

    <!-- Search Input Demo -->
    <section class="demo-section">
        <h2>1. Search Input with API Simulation</h2>
        <p>Demonstrates debounced API calls with loading states and error handling.</p>

        <div class="demo-controls">
            <div class="input-group">
                <label for="search-input">Search Users</label>
                <input
                    type="text"
                    id="search-input"
                    placeholder="Type to search..."
                >
            </div>
        </div>

        <div class="metrics">
            <div class="metric-card">
                <h4>API Calls</h4>
                <div class="metric-value" id="api-calls">0</div>
            </div>
            <div class="metric-card">
                <h4>Last Delay</h4>
                <div class="metric-value" id="last-delay">0ms</div>
            </div>
            <div class="metric-card">
                <h4>Status</h4>
                <div class="metric-value" id="search-status">
                    <span class="status status-success">Ready</span>
                </div>
            </div>
        </div>

        <div class="results" id="search-results"></div>

        <div class="code-block">
                <pre><code class="language-typescript">const debouncedSearch = debounce(
    async (query: string): Promise&lt;SearchResult[]&gt; => {
        const results = await api.search(query);
        return results;
    },
    {
        wait: 300,
        leading: false,
        trailing: true,
        maxWait: 1000
    }
);</code></pre>
        </div>
    </section>

    <!-- Window Resize Demo -->
    <section class="demo-section">
        <h2>2. Window Resize Handler</h2>
        <p>Demonstrates efficient window resize handling with debouncing.</p>
        <p class="warning">
            <span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
            </span>

            <strong>Warning:</strong>

            It's not recommended to use debouncing for resize events in production.
            This demo is for illustrative purposes only.
            Please use throttling for resize or mouse events to avoid performance issues. Check alternative package <a
                href="https://www.npmjs.com/package/@avati/throttle" target="_blank">Throttle</a>.
        </p>

        <div class="metrics">
            <div class="metric-card">
                <h4>Window Width</h4>
                <div class="metric-value" id="window-width">-</div>
            </div>
            <div class="metric-card">
                <h4>Window Height</h4>
                <div class="metric-value" id="window-height">-</div>
            </div>
            <div class="metric-card">
                <h4>Resize Events</h4>
                <div class="metric-value" id="resize-count">0</div>
            </div>
        </div>

        <div class="chart" id="resize-chart"></div>

        <div class="code-block">
                <pre><code class="language-typescript">const debouncedResize = debounce(
    (dimensions: Dimensions) => {
        updateLayout(dimensions);
    },
    {
        wait: 150,
        leading: true,
        trailing: true,
        maxWait: 500
    }
);</code></pre>
        </div>
    </section>

    <!-- Form Validation Demo -->
    <section class="demo-section">
        <h2>3. Real-time Form Validation</h2>
        <p>Demonstrates debounced form validation with error handling.</p>

        <div class="demo-controls">
            <div class="input-group">
                <label for="email-input">Email</label>
                <input
                    type="email"
                    id="email-input"
                    placeholder="Enter email..."
                >
            </div>
        </div>

        <div class="metrics">
            <div class="metric-card">
                <h4>Validation Calls</h4>
                <div class="metric-value" id="validation-calls">0</div>
            </div>
            <div class="metric-card">
                <h4>Status</h4>
                <div class="metric-value" id="validation-status">
                    <span class="status status-pending">Not Validated</span>
                </div>
            </div>
        </div>

        <div class="code-block">
                <pre><code class="language-typescript">const debouncedValidate = debounce(
    async (email: string): Promise&lt;ValidationResult&gt; => {
        const result = await validateEmail(email);
        return result;
    },
    {
        wait: 500,
        leading: false,
        trailing: true
    }
);</code></pre>
        </div>
    </section>
</div>

<script src="../dist/index.umd.js"></script>
<script>

    const { debounce } = window['@avati/debounce'];
    // Highlight.js initialization
    hljs.highlightAll();

    // Mock API delay
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

    // Utility to format numbers
    const formatNumber = n => n.toLocaleString();

    // Mock data
    const mockUsers = [
        { id: 1, name: 'John Doe', email: 'john@example.com' },
        { id: 2, name: 'Jane Smith', email: 'jane@example.com' },
        { id: 3, name: 'Bob Johnson', email: 'bob@example.com' },
    ];

    // Metrics tracking
    let metrics = {
        apiCalls: 0,
        lastDelay: 0,
        resizeCount: 0,
        validationCalls: 0,
    };


    // Search demo
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const apiCallsElement = document.getElementById('api-calls');
    const lastDelayElement = document.getElementById('last-delay');
    const searchStatusElement = document.getElementById('search-status');

    const updateSearchMetrics = () => {
        apiCallsElement.textContent = formatNumber(metrics.apiCalls);
        lastDelayElement.textContent = `${metrics.lastDelay}ms`;
    };

    const mockSearch = async (query) => {
        metrics.apiCalls++;
        updateSearchMetrics();

        searchStatusElement.innerHTML = `
                <span class="status status-pending">Searching...</span>
            `;

        const startTime = Date.now();

        // Simulate API delay
        await delay(300);

        metrics.lastDelay = Date.now() - startTime;
        updateSearchMetrics();

        const results = mockUsers.filter(user =>
            user.name.toLowerCase().includes(query.toLowerCase()) ||
            user.email.toLowerCase().includes(query.toLowerCase()),
        );

        searchStatusElement.innerHTML = `
                <span class="status status-success">Results Found</span>
            `;

        return results;
    };

    const debouncedSearch = debounce(async (query) => {
        if (!query) {
            searchResults.innerHTML = '';
            return;
        }

        const results = await mockSearch(query);

        searchResults.innerHTML = results.map(user => `
                <div class="result-item">
                    <strong>${user.name}</strong>
                    <br>
                    <small>${user.email}</small>
                </div>
            `).join('');
    }, {
        wait: 500,
        leading: false,
        trailing: true,
        maxWait: 1000,
    });

    searchInput.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });

    // Window resize demo
    const windowWidthElement = document.getElementById('window-width');
    const windowHeightElement = document.getElementById('window-height');
    const resizeCountElement = document.getElementById('resize-count');

    const updateResizeMetrics = () => {
        windowWidthElement.textContent = `${window.innerWidth}px`;
        windowHeightElement.textContent = `${window.innerHeight}px`;
        resizeCountElement.textContent = formatNumber(metrics.resizeCount);
    };

    const debouncedResize = debounce(() => {
        metrics.resizeCount++;
        updateResizeMetrics();
    }, {
        wait: 150,
        leading: true,
        trailing: true,
        maxWait: 500,
    });

    window.addEventListener('resize', debouncedResize);
    updateResizeMetrics(); // Initial values

    // Form validation demo
    const emailInput = document.getElementById('email-input');
    const validationCallsElement = document.getElementById('validation-calls');
    const validationStatusElement = document.getElementById('validation-status');

    const mockValidateEmail = async (email) => {
        metrics.validationCalls++;
        validationCallsElement.textContent = formatNumber(metrics.validationCalls);

        validationStatusElement.innerHTML = `
                <span class="status status-pending">Validating...</span>
            `;

        await delay(500);

        const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

        validationStatusElement.innerHTML = isValid
            ? '<span class="status status-success">Valid</span>'
            : '<span class="status status-danger">Invalid</span>';

        return isValid;
    };

    const debouncedValidate = debounce(async (email) => {
        if (!email) {
            validationStatusElement.innerHTML = `
                    <span class="status status-pending">Not Validated</span>
                `;
            return;
        }
        await mockValidateEmail(email);
    }, {
        wait: 500,
        leading: false,
        trailing: true
    });

    emailInput.addEventListener('input', (e) => {
        debouncedValidate(e.target.value);
    });

    // Auto-updating chart for resize demo
    class SimpleChart {
        constructor(container) {
            this.container = container;
            this.data = [];
            this.maxDataPoints = 50;
            this.canvas = document.createElement('canvas');
            this.canvas.width = container.clientWidth;
            this.canvas.height = container.clientHeight;
            this.container.appendChild(this.canvas);
            this.ctx = this.canvas.getContext('2d');
        }

        addDataPoint(value) {
            this.data.push(value);
            if (this.data.length > this.maxDataPoints) {
                this.data.shift();
            }
            this.draw();
        }

        draw() {
            const ctx = this.ctx;
            const width = this.canvas.width;
            const height = this.canvas.height;
            const padding = 20;

            // Clear canvas
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, width, height);

            if (this.data.length < 2) return;

            // Find min and max values
            const max = Math.max(...this.data);
            const min = Math.min(...this.data);

            // Draw grid
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 1; i < 5; i++) {
                const y = padding + (height - 2 * padding) * (i / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Draw line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            this.data.forEach((value, index) => {
                const x = padding + (width - 2 * padding) * (index / (this.maxDataPoints - 1));
                const y = padding + (height - 2 * padding) * (1 - (value - min) / (max - min));
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }
    }

    // Initialize resize chart
    const resizeChart = new SimpleChart(document.getElementById('resize-chart'));
    window.addEventListener('resize', () => {
        resizeChart.addDataPoint(window.innerWidth);
    });
    resizeChart.addDataPoint(window.innerWidth);

    // Add a new section for Rate Limiting Demo
    const rateLimitSection = document.createElement('section');
    rateLimitSection.className = 'demo-section';
    rateLimitSection.innerHTML = `
            <h2>4. API Rate Limiting</h2>
            <p>Demonstrates prevention of API rate limiting with debouncing.</p>

            <div class="demo-controls">
                <div class="input-group">
                    <label for="api-input">Quick API Calls</label>
                    <input
                        type="text"
                        id="api-input"
                        placeholder="Type to make API calls..."
                    >
                </div>
            </div>

            <div class="metrics">
                <div class="metric-card">
                    <h4>Total Requests</h4>
                    <div class="metric-value" id="total-requests">0</div>
                </div>
                <div class="metric-card">
                    <h4>Rate Limited</h4>
                    <div class="metric-value" id="rate-limited">0</div>
                </div>
                <div class="metric-card">
                    <h4>Success Rate</h4>
                    <div class="metric-value" id="success-rate">100%</div>
                </div>
            </div>

            <div class="code-block">
                <pre><code class="language-typescript">const debouncedApiCall = debounce(
    async (input: string): Promise&lt;ApiResponse&gt; => {
        if (isRateLimited()) {
            throw new RateLimitError();
        }
        return await api.process(input);
    },
    {
        wait: 1000,
        maxWait: 2000,
        leading: false,
        trailing: true
    }
);</code></pre>
            </div>
        `;
    document.querySelector('.container').appendChild(rateLimitSection);

    // Rate Limiting Demo Implementation
    let apiMetrics = {
        totalRequests: 0,
        rateLimited: 0,
        lastRequestTime: 0,
    };

    const totalRequestsElement = document.getElementById('total-requests');
    const rateLimitedElement = document.getElementById('rate-limited');
    const successRateElement = document.getElementById('success-rate');

    const updateApiMetrics = () => {
        totalRequestsElement.textContent = formatNumber(apiMetrics.totalRequests);
        rateLimitedElement.textContent = formatNumber(apiMetrics.rateLimited);
        const successRate = apiMetrics.totalRequests === 0 ? 100 :
            ((apiMetrics.totalRequests - apiMetrics.rateLimited) / apiMetrics.totalRequests * 100).toFixed(1);
        successRateElement.textContent = `${successRate}%`;
    };

    const mockApiCall = async (input) => {
        apiMetrics.totalRequests++;
        const now = Date.now();

        // Simulate rate limiting if calls are too frequent
        if (now - apiMetrics.lastRequestTime < 1000) {
            apiMetrics.rateLimited++;
            updateApiMetrics();
            throw new Error('Rate limited');
        }

        apiMetrics.lastRequestTime = now;
        await delay(300);
        updateApiMetrics();
        return { success: true, input };
    };

    const debouncedApiCall = debounce(async (input) => {
        try {
            await mockApiCall(input);
        } catch (error) {
            console.error('API call failed:', error);
        }
    },  {
        wait: 1000,
        maxWait: 2000,
        leading: false,
        trailing: true
    });

    const apiInput = document.getElementById('api-input');
    apiInput?.addEventListener('input', (e) => {
        debouncedApiCall(e.target.value);
    });

    // Add keyboard shortcuts info
    const shortcutsSection = document.createElement('section');
    shortcutsSection.className = 'demo-section';
    shortcutsSection.innerHTML = `
            <h2>Keyboard Shortcuts</h2>
            <p>Try these shortcuts to test the demos:</p>
            <ul style="list-style: none; margin-top: 1rem;">
                <li><kbd style="background: #f1f5f9; padding: 0.2rem 0.5rem; border-radius: 0.25rem;">Ctrl + S</kbd> - Trigger search</li>
                <li><kbd style="background: #f1f5f9; padding: 0.2rem 0.5rem; border-radius: 0.25rem;">Ctrl + R</kbd> - Reset metrics</li>
            </ul>
        `;
    document.querySelector('.container').appendChild(shortcutsSection);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            searchInput.focus();
        } else if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            metrics = {
                apiCalls: 0,
                lastDelay: 0,
                resizeCount: 0,
                validationCalls: 0,
            };
            apiMetrics = {
                totalRequests: 0,
                rateLimited: 0,
                lastRequestTime: 0,
            };
            updateSearchMetrics();
            updateResizeMetrics();
            updateApiMetrics();
        }
    });

    // Add copy to clipboard functionality for code blocks
    document.querySelectorAll('.code-block').forEach(block => {
        const button = document.createElement('button');
        button.innerHTML = 'Copy';
        button.style.cssText = `
                position: absolute;
                right: 1rem;
                top: 1rem;
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 0.25rem;
                color: white;
                cursor: pointer;
            `;
        block.style.position = 'relative';
        block.appendChild(button);

        button.addEventListener('click', async () => {
            const code = block.querySelector('code').textContent;
            await navigator.clipboard.writeText(code);
            button.innerHTML = 'Copied!';
            setTimeout(() => {
                button.innerHTML = 'Copy';
            }, 2000);
        });
    });
</script>
</body>
</html>
